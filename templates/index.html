<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>HAProxy Configurator</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=Sora:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="app-shell">
    <div class="app-layout">
        <aside class="sidebar">
            <a href="/home" class="brand-link">
                <span class="brand-icon"><i class="fas fa-globe"></i></span>
                <span class="brand-text">
                    <span class="brand-title">HAProxy Configurator</span>
                    <span class="brand-subtitle">Routing control center</span>
                </span>
            </a>
            <nav class="sidebar-nav">
                <div class="nav-section">Overview</div>
                <a href="/home" class="nav-item"><i class="fas fa-chart-line"></i>Dashboard</a>
                <div class="nav-section">Configuration</div>
                <a href="/" class="nav-item active"><i class="fas fa-plus-circle"></i>Add Proxy</a>
                <a href="/manage" class="nav-item"><i class="fas fa-layer-group"></i>Proxies</a>
                <a href="/config" class="nav-item"><i class="fas fa-cogs"></i>Base Config</a>
                <div class="nav-section">TLS & Security</div>
                <a href="/certificates" class="nav-item"><i class="fas fa-lock"></i>Certificates</a>
                <a href="/logs" class="nav-item"><i class="fas fa-shield-alt"></i>Security Events</a>
                <div class="nav-section">Analytics</div>
                <a href="/statistics" class="nav-item"><i class="fas fa-wave-square"></i>Statistics</a>
                <a href="http://{{ request.host.split(':')[0] }}:8080/stats" class="nav-item" target="_blank"><i class="fas fa-external-link-alt"></i>HAProxy Stats</a>
            </nav>
            <div class="sidebar-footer">
                <div class="theme-toggle">
                    <span>Dark mode</span>
                    <label class="switch">
                        <input type="checkbox" data-theme-toggle>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </aside>

        <div class="content-area">
            <header class="page-header">
                <h1>Build a new frontend</h1>
                <p>Configure listener, security rules, and backend pool in one pass.</p>
            </header>

            {% set fd = form_data or {} %}
            <main>

    <div id="frontend_container" class="card-surface{% if backend_only %} is-disabled{% endif %}">
         <div class="section-title"><i style="margin-right: 8px;" class="fas fa-globe"></i>Frontend details</div>
         <div class="section-subtitle">Define the listener and protocol settings for incoming traffic.</div>
        <!-- Display success message when the form is submitted successfully -->
        {% if message %}
      <div class="alert {% if 'already exists' in message %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endif %}

      <form method="post" action="/">
        <input type="hidden" name="form_mode" value="{{ form_mode }}">
        <input type="hidden" name="frontend_id" value="{{ fd.frontend_id }}">
        <input type="hidden" name="backend_id" value="{{ fd.backend_id }}">
    <div class="form-row">
        <div class="form-group">
            <label for="frontend_name">Frontend Name:</label>
            <input type="text" class="form-control" name="frontend_name" value="{{ fd.frontend_name }}" {% if backend_only %}disabled{% endif %} required>
        </div>
        <div class="form-group">
            <label for="frontend_ip">Bind IP:</label>
            <input type="text" class="form-control" name="frontend_ip" placeholder="0.0.0.0" value="{{ fd.frontend_ip }}" {% if backend_only %}disabled{% endif %}>
        </div>
        <div class="form-group">
            <label for="frontend_port">Bind Port:</label>
            <input type="text" class="form-control" name="frontend_port" placeholder="80" value="{{ fd.frontend_port }}" {% if backend_only %}disabled{% endif %}>
        </div>
    </div>

    <div class="form-group" id="domain_fields" style="display: none;">
        <label for="domain_name">Domain / Hostname:</label>
        <input type="text" id="domain_name" class="form-control" name="domain_name" placeholder="example.com" value="{{ fd.domain_name }}" {% if backend_only %}disabled{% endif %}>
        <small class="text-muted">Required for SSL certificates and host-based routing.</small>
    </div>

    <!-- Checkbox for SSL Certificate -->
    <div class="form-check">
        <input type="checkbox" class="form-check-input" id="ssl_checkbox" name="ssl_checkbox" {% if fd.use_ssl %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
        <label class="form-check-label" for="ssl_checkbox"><i style="margin: 8px;" class="fas fa-lock"></i>Use SSL Certificate</label>
    </div>

    <!-- Fields for SSL Certificate Path and SSL Key Path (Hidden by default) -->
    <div class="form-group" style="display: none;" id="ssl_fields">
        <div class="form-group">
            <label for="ssl_mode">Certificate Option:</label>
            <select class="form-control" id="ssl_mode" name="ssl_mode" {% if backend_only %}disabled{% endif %}>
                <option value="acme" {% if fd.ssl_mode == 'acme' %}selected{% endif %}>Request New Certificate (ACME)</option>
                <option value="existing" {% if fd.ssl_mode != 'acme' %}selected{% endif %}>Select Existing Certificate</option>
            </select>
        </div>

        <div class="form-group" id="acme_fields" style="display: none;">
            <small class="text-muted">Certificate will be issued for the domain above.</small>
        </div>

        <div class="form-group" id="existing_cert_fields" style="display: none;">
            <label for="ssl_cert_path_select">Select Certificate:</label>
            <select class="form-control" id="ssl_cert_path_select" name="ssl_cert_path_select" {% if backend_only %}disabled{% endif %}>
                {% if certificates %}
                    <option value="" selected disabled>Choose a certificate</option>
                    {% for cert in certificates %}
                        <option value="{{ cert.id }}" {% if fd.ssl_cert_id|int == cert.id %}selected{% endif %}>{{ cert.domain }} (expires {{ cert.expires_at }})</option>
                    {% endfor %}
                {% else %}
                    <option value="" selected disabled>No certificates found</option>
                {% endif %}
                <option value="__custom__">Custom path...</option>
            </select>
        </div>

        <div class="form-group" id="manual_cert_fields" style="display: none;">
            <label for="ssl_cert_path_manual">SSL Certificate Path (PEM):</label>
            <input type="text" id="ssl_cert_path_manual" class="form-control" name="ssl_cert_path_manual" placeholder="/etc/haproxy-configurator/ssl/example.com.pem" {% if backend_only %}disabled{% endif %}>
        </div>
        <div style="padding-bottom: 15px;" class="form-check">
            <input type="checkbox" class="form-check-input" id="ssl_redirect_checkbox" name="ssl_redirect_checkbox" {% if fd.https_redirect %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
            <label class="form-check-label" for="ssl_redirect_checkbox"><i style="margin: 8px;" class="fas fa-arrow-circle-right"></i>Add Redirect to HTTPS</label>
        </div>
    </div>

    <div style="margin-top: 15px;" class="form-group">
        <label for="lb_method">Load Balancing Method:</label>
        <select class="form-control" name="lb_method" id="lb_method" {% if backend_only %}disabled{% endif %}>
            <option value="roundrobin" {% if fd.lb_method == 'roundrobin' %}selected{% endif %}>Round Robin</option>
            <option value="leastconn" {% if fd.lb_method == 'leastconn' %}selected{% endif %}>Least Connections</option>
            <option value="source" {% if fd.lb_method == 'source' %}selected{% endif %}>Source</option>
            <option value="wrr" {% if fd.lb_method == 'wrr' %}selected{% endif %}>WRR</option>
            <option value="wlc" {% if fd.lb_method == 'wlc' %}selected{% endif %}>WLC</option>
            <option value="random" {% if fd.lb_method == 'random' %}selected{% endif %}>Random</option>
        </select>
    </div>

    <div class="form-group">
        <label for="protocol">Protocol:</label>
        <select class="form-control" name="protocol" id="protocol" {% if backend_only %}disabled{% endif %} required>
            <option value="http" {% if fd.protocol != 'http' %}selected{% endif %}>HTTP</option>
        </select>
    </div>

    <!-- DOS Protection -->
    <div class="form-check">
        <input type="checkbox" class="form-check-input" name="add_dos" id="add_dos" {% if fd.dos_enabled %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
        <label style="margin-bottom: 10px;" class="form-check-label" for="add_dos"><i style="margin: 8px;" class="fas fa-shield-alt"></i> Add DOS Protection</label>
    </div>

    <div class="form-group" id="dos_fields" style="display: none; padding-bottom: 20px;">
        <label for="limit_requests">Limit Requests, e.g: 20:</label>
        <input type="text" class="form-control" name="limit_requests" value="{{ fd.limit_requests }}" {% if backend_only %}disabled{% endif %}>
        <label for="ban_duration">IP Ban Duration(in seconds, e.g: 15s):</label>
        <input type="text" class="form-control" name="ban_duration" value="{{ fd.ban_duration }}" {% if backend_only %}disabled{% endif %}>
    </div>

    <!-- SQL Injection -->
    <div style="margin-top: 8px; padding-bottom: 15px; display: none;" class="form-check" id="sql_injection_container">
        <input type="checkbox" class="form-check-input" id="sql_injection_check" name="sql_injection_check" {% if fd.sql_injection_enabled %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
        <label class="form-check-label" for="sql_injection_check"><i style="margin: 8px;" class="fas fa-shield-alt"></i>Activate SQL Injection Protection</label>
    </div>

    <!-- XSS -->
    <div style="margin-top: 8px; padding-bottom: 15px; display: none;" class="form-check" id="XSS_container">
        <input type="checkbox" class="form-check-input" id="xss_check" name="xss_check" {% if fd.xss_enabled %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
        <label class="form-check-label" for="xss_check"><i style="margin: 8px;" class="fas fa-shield-alt"></i>Activate XSS Protection</label>
    </div>

    <!-- Remote File Uploads -->
    <div style="margin-top: 8px; padding-bottom: 15px; display: none;" class="form-check" id="remote_uploads_container">
        <input type="checkbox" class="form-check-input" id="remote_uploads_check" name="remote_uploads_check" {% if fd.remote_upload_enabled %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
        <label class="form-check-label" for="remote_uploads_check"><i style="margin: 8px;" class="fas fa-shield-alt"></i>Activate Remote File Upload Protection</label>
    </div>

    <!-- Deny Webshells -->
    <div style="margin-top: 8px; padding-bottom: 15px; display: none;" class="form-check" id="webshells_container">
        <input type="checkbox" class="form-check-input" id="webshells_check" name="webshells_check" {% if fd.webshells_enabled %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
        <label class="form-check-label" for="webshells_check"><i style="margin: 8px;" class="fas fa-shield-alt"></i>Activate Webshells Protection</label>
    </div>

    <div class="section-title"><i style="margin-right: 8px;" class="fas fa-user-lock"></i>ACL rules</div>
    <div class="section-subtitle">Add multiple ACL rules and route to a backend by name.</div>
    <div id="acl_rows_container">
        {% if fd.acls %}
            {% for acl in fd.acls %}
            <div class="form-row acl-row">
                <div class="form-group">
                    <label>ACL Name:</label>
                    <input type="text" class="form-control acl-name" value="{{ acl.name }}">
                </div>
                <div class="form-group">
                    <label>ACL Action:</label>
                    <input type="text" class="form-control acl-action" value="{{ acl.action }}">
                </div>
                <div class="form-group">
                    <label>Backend Name:</label>
                    <input type="text" class="form-control acl-backend" value="{{ acl.backend_name }}">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeAclRow(this)">Remove</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="form-row acl-row">
                <div class="form-group">
                    <label>ACL Name:</label>
                    <input type="text" class="form-control acl-name" placeholder="acl_name">
                </div>
                <div class="form-group">
                    <label>ACL Action:</label>
                    <input type="text" class="form-control acl-action" placeholder="hdr(host) -i example.com">
                </div>
                <div class="form-group">
                    <label>Backend Name:</label>
                    <input type="text" class="form-control acl-backend" placeholder="backend_name">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeAclRow(this)">Remove</button>
                </div>
            </div>
        {% endif %}
    </div>
    <div style="margin-top: 12px;">
        <button type="button" class="btn btn-outline-secondary" onclick="addAclRow()">+ Add ACL</button>
    </div>
    <input type="hidden" id="acl_payload" name="acl_payload">

    <div class="section-title"><i style="margin-right: 8px;" class="fas fa-ban"></i>Block sensitive paths</div>
    <div class="section-subtitle">Add multiple path blocks with allowed IPs.</div>
    <div id="forbidden_rows_container">
        {% if fd.forbidden_paths %}
            {% for rule in fd.forbidden_paths %}
            <div class="form-row forbidden-row">
                <div class="form-group">
                    <label>ACL Name:</label>
                    <input type="text" class="form-control forbidden-name" value="{{ rule.acl_name }}">
                </div>
                <div class="form-group">
                    <label>Allowed IPs:</label>
                    <input type="text" class="form-control forbidden-allowed" value="{{ rule.allowed_ip }}">
                </div>
                <div class="form-group">
                    <label>Path:</label>
                    <input type="text" class="form-control forbidden-path" value="{{ rule.path }}">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeForbiddenRow(this)">Remove</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="form-row forbidden-row">
                <div class="form-group">
                    <label>ACL Name:</label>
                    <input type="text" class="form-control forbidden-name" placeholder="block_admin">
                </div>
                <div class="form-group">
                    <label>Allowed IPs:</label>
                    <input type="text" class="form-control forbidden-allowed" placeholder="192.168.1.2 192.168.1.3">
                </div>
                <div class="form-group">
                    <label>Path:</label>
                    <input type="text" class="form-control forbidden-path" placeholder="/admin">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeForbiddenRow(this)">Remove</button>
                </div>
            </div>
        {% endif %}
    </div>
    <div style="margin-top: 12px;">
        <button type="button" class="btn btn-outline-secondary" onclick="addForbiddenRow()">+ Add Path Block</button>
    </div>
    <input type="hidden" id="forbidden_payload" name="forbidden_payload">

    <div class="section-title"><i style="margin-right: 8px;" class="fas fa-arrow-circle-right"></i>Path redirects</div>
    <div class="section-subtitle">Add multiple path-based redirects.</div>
    <div id="redirect_rows_container">
        {% if fd.redirect_rules %}
            {% for rule in fd.redirect_rules %}
            <div class="form-row redirect-row">
                <div class="form-group">
                    <label>Host Match:</label>
                    <input type="text" class="form-control redirect-host" value="{{ rule.host_match }}">
                </div>
                <div class="form-group">
                    <label>Root Path:</label>
                    <input type="text" class="form-control redirect-root" value="{{ rule.root_path }}">
                </div>
                <div class="form-group">
                    <label>Redirect To:</label>
                    <input type="text" class="form-control redirect-to" value="{{ rule.redirect_to }}">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeRedirectRow(this)">Remove</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="form-row redirect-row">
                <div class="form-group">
                    <label>Host Match:</label>
                    <input type="text" class="form-control redirect-host" placeholder="app.example.com">
                </div>
                <div class="form-group">
                    <label>Root Path:</label>
                    <input type="text" class="form-control redirect-root" placeholder="/">
                </div>
                <div class="form-group">
                    <label>Redirect To:</label>
                    <input type="text" class="form-control redirect-to" placeholder="/new-path">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeRedirectRow(this)">Remove</button>
                </div>
            </div>
        {% endif %}
    </div>
    <div style="margin-top: 12px;">
        <button type="button" class="btn btn-outline-secondary" onclick="addRedirectRow()">+ Add Redirect</button>
    </div>
    <input type="hidden" id="redirect_payload" name="redirect_payload">

    <div style="margin-top: 8px; padding-bottom: 15px; display: none;" class="form-check" id="forward_for_container">
        <input type="checkbox" class="form-check-input" id="forward_for_check" name="forward_for_check" {% if fd.forward_for %}checked{% endif %} {% if backend_only %}disabled{% endif %}>
        <label class="form-check-label" for="forward_for_check"><i style="margin: 8px;" class="fas fa-network-wired"></i>Use option forwardfor</label>
    </div>

    </div>

    <div id="backend_container" class="card-surface">
        <div class="section-title"><i style="margin-right: 8px;" class="fas fa-sitemap"></i>Backend pools</div>
        <div class="section-subtitle">Create multiple backend pools and choose a default.</div>

        <div id="backend_blocks_container">
            {% set backend_blocks = fd.backend_blocks if fd.backend_blocks else [] %}
            {% if backend_blocks %}
                {% for block in backend_blocks %}
                <div class="backend-block" data-index="{{ loop.index0 }}">
                    <div class="table-header">
                        <div>
                            <div class="section-title">Backend {{ loop.index }}</div>
                            <div class="section-subtitle">Name + health, sticky, and server targets.</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="default_backend_index" value="{{ loop.index0 }}" {% if block.is_default %}checked{% endif %}>
                            <label class="form-check-label">Default</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Backend Name:</label>
                            <input type="text" class="form-control backend-name" value="{{ block.name }}" required>
                        </div>
                        <div class="form-group">
                            <label>Mode:</label>
                            <select class="form-control backend-mode">
                                <option value="http" {% if block.mode == 'http' %}selected{% endif %}>HTTP</option>
                                <option value="tcp" {% if block.mode == 'tcp' %}selected{% endif %}>TCP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input backend-sticky-session" type="checkbox" {% if block.sticky_session %}checked{% endif %}>
                                <label class="form-check-label">Sticky Session</label>
                            </div>
                            <select class="form-control backend-sticky-type">
                                <option value="cookie" {% if block.sticky_session_type == 'cookie' %}selected{% endif %}>Cookie</option>
                                <option value="stick-table" {% if block.sticky_session_type == 'stick-table' %}selected{% endif %}>Stick-table</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input backend-health-check" type="checkbox" {% if block.health_check %}checked{% endif %}>
                                <label class="form-check-label">HTTP Health Check</label>
                            </div>
                            <input type="text" class="form-control backend-health-check-link" placeholder="/health" value="{{ block.health_check_link }}">
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input backend-health-check-tcp" type="checkbox" {% if block.health_check_tcp %}checked{% endif %}>
                                <label class="form-check-label">TCP Health Check</label>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">Custom headers</div>
                    <div class="backend-headers">
                        {% if block.headers %}
                            {% for header in block.headers %}
                            <div class="form-row backend-header-row">
                                <div class="form-group">
                                    <label>Header Name:</label>
                                    <input type="text" class="form-control header-name" value="{{ header.name }}">
                                </div>
                                <div class="form-group">
                                    <label>Header Value:</label>
                                    <input type="text" class="form-control header-value" value="{{ header.value }}">
                                </div>
                                <div class="form-group">
                                    <div class="form-check" style="margin-top: 8px;">
                                        <input class="form-check-input header-enabled" type="checkbox" {% if header.enabled %}checked{% endif %}>
                                        <label class="form-check-label">Enabled</label>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeHeaderRow(this)">Remove</button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="form-row backend-header-row">
                                <div class="form-group">
                                    <label>Header Name:</label>
                                    <input type="text" class="form-control header-name" placeholder="X-Forwarded-Host">
                                </div>
                                <div class="form-group">
                                    <label>Header Value:</label>
                                    <input type="text" class="form-control header-value" placeholder="example.com">
                                </div>
                                <div class="form-group">
                                    <div class="form-check" style="margin-top: 8px;">
                                        <input class="form-check-input header-enabled" type="checkbox" checked>
                                        <label class="form-check-label">Enabled</label>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeHeaderRow(this)">Remove</button>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-outline-secondary" onclick="addHeaderRow(this)">+ Add Header</button>
                    </div>

                    <div class="section-title">Servers</div>
                    <div class="backend-servers">
                        {% for server in block.servers %}
                        <div class="form-row backend-server-row">
                            <div class="form-group">
                                <label>Server Name:</label>
                                <input type="text" class="form-control server-name" value="{{ server.name }}" required>
                            </div>
                            <div class="form-group">
                                <label>IP:</label>
                                <input type="text" class="form-control server-ip" value="{{ server.ip }}" required>
                            </div>
                            <div class="form-group">
                                <label>Port:</label>
                                <input type="number" class="form-control server-port" value="{{ server.port }}" required>
                            </div>
                            <div class="form-group">
                                <label>MaxConn:</label>
                                <input type="number" class="form-control server-maxconn" value="{{ server.maxconn }}">
                                <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeBackendServer(this)">Remove</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-outline-secondary" onclick="addBackendServer(this)">+ Add Server</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="removeBackendBlock(this)">Remove Backend</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="backend-block" data-index="0">
                    <div class="table-header">
                        <div>
                            <div class="section-title">Backend 1</div>
                            <div class="section-subtitle">Name + health, sticky, and server targets.</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="default_backend_index" value="0" checked>
                            <label class="form-check-label">Default</label>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Backend Name:</label>
                            <input type="text" class="form-control backend-name" required>
                        </div>
                        <div class="form-group">
                            <label>Mode:</label>
                            <select class="form-control backend-mode">
                                <option value="http" selected>HTTP</option>
                                <option value="tcp">TCP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input backend-sticky-session" type="checkbox">
                                <label class="form-check-label">Sticky Session</label>
                            </div>
                            <select class="form-control backend-sticky-type">
                                <option value="cookie" selected>Cookie</option>
                                <option value="stick-table">Stick-table</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input backend-health-check" type="checkbox">
                                <label class="form-check-label">HTTP Health Check</label>
                            </div>
                            <input type="text" class="form-control backend-health-check-link" placeholder="/health">
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input backend-health-check-tcp" type="checkbox">
                                <label class="form-check-label">TCP Health Check</label>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">Custom headers</div>
                    <div class="backend-headers">
                        <div class="form-row backend-header-row">
                            <div class="form-group">
                                <label>Header Name:</label>
                                <input type="text" class="form-control header-name" placeholder="X-Forwarded-Host">
                            </div>
                            <div class="form-group">
                                <label>Header Value:</label>
                                <input type="text" class="form-control header-value" placeholder="example.com">
                            </div>
                            <div class="form-group">
                                <div class="form-check" style="margin-top: 8px;">
                                    <input class="form-check-input header-enabled" type="checkbox" checked>
                                    <label class="form-check-label">Enabled</label>
                                </div>
                                <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeHeaderRow(this)">Remove</button>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-outline-secondary" onclick="addHeaderRow(this)">+ Add Header</button>
                    </div>

                    <div class="section-title">Servers</div>
                    <div class="backend-servers">
                        <div class="form-row backend-server-row">
                            <div class="form-group">
                                <label>Server Name:</label>
                                <input type="text" class="form-control server-name" placeholder="server1" required>
                            </div>
                            <div class="form-group">
                                <label>IP:</label>
                                <input type="text" class="form-control server-ip" required>
                            </div>
                            <div class="form-group">
                                <label>Port:</label>
                                <input type="number" class="form-control server-port" required>
                            </div>
                            <div class="form-group">
                                <label>MaxConn:</label>
                                <input type="number" class="form-control server-maxconn">
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 12px;">
                        <button type="button" class="btn btn-outline-secondary" onclick="addBackendServer(this)">+ Add Server</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="removeBackendBlock(this)">Remove Backend</button>
                    </div>
                </div>
            {% endif %}
        </div>

        <div style="margin-top: 12px;">
            <button type="button" class="btn btn-outline-secondary" onclick="addBackendBlock()">+ Add Backend Block</button>
            <input type="submit" id="success_btn" class="btn btn-primary" value="{{ 'Update' if form_mode != 'create' else 'Submit' }}">
        </div>
        <input type="hidden" id="backend_blocks_payload" name="backend_blocks_payload">
    </div>

    </form>

    <script>
        function addBackendBlock() {
            const container = document.getElementById('backend_blocks_container');
            const index = container.querySelectorAll('.backend-block').length;
            const block = document.createElement('div');
            block.classList.add('backend-block');
            block.dataset.index = index;
            block.innerHTML = `
                <div class="table-header">
                    <div>
                        <div class="section-title">Backend ${index + 1}</div>
                        <div class="section-subtitle">Name + health, sticky, and server targets.</div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="default_backend_index" value="${index}">
                        <label class="form-check-label">Default</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Backend Name:</label>
                        <input type="text" class="form-control backend-name" required>
                    </div>
                    <div class="form-group">
                        <label>Mode:</label>
                        <select class="form-control backend-mode">
                            <option value="http" selected>HTTP</option>
                            <option value="tcp">TCP</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input backend-sticky-session" type="checkbox">
                            <label class="form-check-label">Sticky Session</label>
                        </div>
                        <select class="form-control backend-sticky-type">
                            <option value="cookie" selected>Cookie</option>
                            <option value="stick-table">Stick-table</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input backend-health-check" type="checkbox">
                            <label class="form-check-label">HTTP Health Check</label>
                        </div>
                        <input type="text" class="form-control backend-health-check-link" placeholder="/health">
                    </div>
                    <div class="form-group">
                        <div class="form-check">
                            <input class="form-check-input backend-health-check-tcp" type="checkbox">
                            <label class="form-check-label">TCP Health Check</label>
                        </div>
                    </div>
                </div>
                <div class="section-title">Custom headers</div>
                <div class="backend-headers">
                    <div class="form-row backend-header-row">
                        <div class="form-group">
                            <label>Header Name:</label>
                            <input type="text" class="form-control header-name" placeholder="X-Forwarded-Host">
                        </div>
                        <div class="form-group">
                            <label>Header Value:</label>
                            <input type="text" class="form-control header-value" placeholder="example.com">
                        </div>
                        <div class="form-group">
                            <div class="form-check" style="margin-top: 8px;">
                                <input class="form-check-input header-enabled" type="checkbox" checked>
                                <label class="form-check-label">Enabled</label>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeHeaderRow(this)">Remove</button>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <button type="button" class="btn btn-outline-secondary" onclick="addHeaderRow(this)">+ Add Header</button>
                </div>
                <div class="section-title">Servers</div>
                <div class="backend-servers">
                    <div class="form-row backend-server-row">
                        <div class="form-group">
                            <label>Server Name:</label>
                            <input type="text" class="form-control server-name" placeholder="server1" required>
                        </div>
                        <div class="form-group">
                            <label>IP:</label>
                            <input type="text" class="form-control server-ip" required>
                        </div>
                        <div class="form-group">
                            <label>Port:</label>
                            <input type="number" class="form-control server-port" required>
                        </div>
                        <div class="form-group">
                            <label>MaxConn:</label>
                            <input type="number" class="form-control server-maxconn">
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <button type="button" class="btn btn-outline-secondary" onclick="addBackendServer(this)">+ Add Server</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="removeBackendBlock(this)">Remove Backend</button>
                </div>
            `;
            container.appendChild(block);
        }

        function removeBackendBlock(button) {
            const block = button.closest('.backend-block');
            const container = document.getElementById('backend_blocks_container');
            if (container.querySelectorAll('.backend-block').length <= 1) {
                alert('You must have at least one backend block.');
                return;
            }
            block.remove();
        }

        function addBackendServer(button) {
            const block = button.closest('.backend-block');
            const container = block.querySelector('.backend-servers');
            const row = document.createElement('div');
            row.classList.add('form-row', 'backend-server-row');
            row.innerHTML = `
                <div class="form-group">
                    <label>Server Name:</label>
                    <input type="text" class="form-control server-name" required>
                </div>
                <div class="form-group">
                    <label>IP:</label>
                    <input type="text" class="form-control server-ip" required>
                </div>
                <div class="form-group">
                    <label>Port:</label>
                    <input type="number" class="form-control server-port" required>
                </div>
                <div class="form-group">
                    <label>MaxConn:</label>
                    <input type="number" class="form-control server-maxconn">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeBackendServer(this)">Remove</button>
                </div>
            `;
            container.appendChild(row);
        }

        function removeBackendServer(button) {
            const row = button.closest('.backend-server-row');
            const container = row.closest('.backend-servers');
            if (container.querySelectorAll('.backend-server-row').length <= 1) {
                alert('You must have at least one backend server.');
                return;
            }
            row.remove();
        }

        function addAclRow() {
            const container = document.getElementById('acl_rows_container');
            const row = document.createElement('div');
            row.classList.add('form-row', 'acl-row');
            row.innerHTML = `
                <div class="form-group">
                    <label>ACL Name:</label>
                    <input type="text" class="form-control acl-name" placeholder="acl_name">
                </div>
                <div class="form-group">
                    <label>ACL Action:</label>
                    <input type="text" class="form-control acl-action" placeholder="hdr(host) -i example.com">
                </div>
                <div class="form-group">
                    <label>Backend Name:</label>
                    <input type="text" class="form-control acl-backend" placeholder="backend_name">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeAclRow(this)">Remove</button>
                </div>
            `;
            container.appendChild(row);
        }

        function removeAclRow(button) {
            const row = button.closest('.acl-row');
            row.remove();
        }

        function addForbiddenRow() {
            const container = document.getElementById('forbidden_rows_container');
            const row = document.createElement('div');
            row.classList.add('form-row', 'forbidden-row');
            row.innerHTML = `
                <div class="form-group">
                    <label>ACL Name:</label>
                    <input type="text" class="form-control forbidden-name" placeholder="block_admin">
                </div>
                <div class="form-group">
                    <label>Allowed IPs:</label>
                    <input type="text" class="form-control forbidden-allowed" placeholder="192.168.1.2 192.168.1.3">
                </div>
                <div class="form-group">
                    <label>Path:</label>
                    <input type="text" class="form-control forbidden-path" placeholder="/admin">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeForbiddenRow(this)">Remove</button>
                </div>
            `;
            container.appendChild(row);
        }

        function removeForbiddenRow(button) {
            const row = button.closest('.forbidden-row');
            row.remove();
        }

        function addRedirectRow() {
            const container = document.getElementById('redirect_rows_container');
            const row = document.createElement('div');
            row.classList.add('form-row', 'redirect-row');
            row.innerHTML = `
                <div class="form-group">
                    <label>Host Match:</label>
                    <input type="text" class="form-control redirect-host" placeholder="app.example.com">
                </div>
                <div class="form-group">
                    <label>Root Path:</label>
                    <input type="text" class="form-control redirect-root" placeholder="/">
                </div>
                <div class="form-group">
                    <label>Redirect To:</label>
                    <input type="text" class="form-control redirect-to" placeholder="/new-path">
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeRedirectRow(this)">Remove</button>
                </div>
            `;
            container.appendChild(row);
        }

        function removeRedirectRow(button) {
            const row = button.closest('.redirect-row');
            row.remove();
        }

        function addHeaderRow(button) {
            const block = button.closest('.backend-block');
            const container = block.querySelector('.backend-headers');
            const row = document.createElement('div');
            row.classList.add('form-row', 'backend-header-row');
            row.innerHTML = `
                <div class="form-group">
                    <label>Header Name:</label>
                    <input type="text" class="form-control header-name" placeholder="X-Forwarded-Host">
                </div>
                <div class="form-group">
                    <label>Header Value:</label>
                    <input type="text" class="form-control header-value" placeholder="example.com">
                </div>
                <div class="form-group">
                    <div class="form-check" style="margin-top: 8px;">
                        <input class="form-check-input header-enabled" type="checkbox" checked>
                        <label class="form-check-label">Enabled</label>
                    </div>
                    <button type="button" class="btn btn-danger btn-sm mt-2" onclick="removeHeaderRow(this)">Remove</button>
                </div>
            `;
            container.appendChild(row);
        }

        function removeHeaderRow(button) {
            const row = button.closest('.backend-header-row');
            row.remove();
        }

        function buildPayloads() {
            const backendBlocks = [];
            const radios = Array.from(document.querySelectorAll('input[name="default_backend_index"]'));
            const defaultIndex = radios.findIndex((radio) => radio.checked);

            document.querySelectorAll('.backend-block').forEach((block, index) => {
                const headers = [];
                block.querySelectorAll('.backend-header-row').forEach((row) => {
                    const name = row.querySelector('.header-name')?.value.trim() || '';
                    const value = row.querySelector('.header-value')?.value.trim() || '';
                    const enabled = row.querySelector('.header-enabled')?.checked || false;
                    if (name) {
                        headers.push({ name, value, enabled });
                    }
                });
                const servers = [];
                block.querySelectorAll('.backend-server-row').forEach((row, serverIndex) => {
                    const name = row.querySelector('.server-name')?.value.trim() || `server${serverIndex + 1}`;
                    const ip = row.querySelector('.server-ip')?.value.trim() || '';
                    const port = row.querySelector('.server-port')?.value.trim() || '';
                    const maxconn = row.querySelector('.server-maxconn')?.value.trim() || '';
                    servers.push({ name, ip, port, maxconn });
                });
                backendBlocks.push({
                    name: block.querySelector('.backend-name')?.value.trim() || '',
                    mode: block.querySelector('.backend-mode')?.value || 'http',
                    is_default: index === (defaultIndex === -1 ? 0 : defaultIndex),
                    health_check: block.querySelector('.backend-health-check')?.checked || false,
                    health_check_link: block.querySelector('.backend-health-check-link')?.value.trim() || '',
                    health_check_tcp: block.querySelector('.backend-health-check-tcp')?.checked || false,
                    sticky_session: block.querySelector('.backend-sticky-session')?.checked || false,
                    sticky_session_type: block.querySelector('.backend-sticky-type')?.value || 'cookie',
                    headers,
                    servers,
                });
            });

            const aclEntries = [];
            document.querySelectorAll('.acl-row').forEach((row) => {
                const name = row.querySelector('.acl-name')?.value.trim() || '';
                const action = row.querySelector('.acl-action')?.value.trim() || '';
                const backend_name = row.querySelector('.acl-backend')?.value.trim() || '';
                aclEntries.push({ name, action, backend_name });
            });

            const forbiddenEntries = [];
            document.querySelectorAll('.forbidden-row').forEach((row) => {
                const acl_name = row.querySelector('.forbidden-name')?.value.trim() || '';
                const allowed_ip = row.querySelector('.forbidden-allowed')?.value.trim() || '';
                const path = row.querySelector('.forbidden-path')?.value.trim() || '';
                forbiddenEntries.push({ acl_name, allowed_ip, path });
            });

            const redirectEntries = [];
            document.querySelectorAll('.redirect-row').forEach((row) => {
                const host_match = row.querySelector('.redirect-host')?.value.trim() || '';
                const root_path = row.querySelector('.redirect-root')?.value.trim() || '';
                const redirect_to = row.querySelector('.redirect-to')?.value.trim() || '';
                redirectEntries.push({ host_match, root_path, redirect_to });
            });

            document.getElementById('backend_blocks_payload').value = JSON.stringify(backendBlocks);
            document.getElementById('acl_payload').value = JSON.stringify(aclEntries);
            document.getElementById('forbidden_payload').value = JSON.stringify(forbiddenEntries);
            document.getElementById('redirect_payload').value = JSON.stringify(redirectEntries);
        }

        const backendForm = document.querySelector('form[action="/"]');
        if (backendForm) {
            backendForm.addEventListener('submit', buildPayloads);
        }
    </script>

    <!-- Add Bootstrap JS and jQuery (required for some Bootstrap components) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.7/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <script>
        // Function to hide the success message after a few seconds
        $(document).ready(function() {
            setTimeout(function() {
                $('.alert').alert('close');
            }, 5000); // Hide the message after 3 seconds (adjust the time as needed)
        });
    </script>

 <script>
        // Function to toggle the visibility of ACL fields based on the checkbox
        const DosCheckbox = document.getElementById('add_dos');
        const DosFields = document.getElementById('dos_fields');

        DosCheckbox.addEventListener('change', () => {
            if (DosCheckbox.checked) {
                DosFields.style.display = 'block';
            } else {
                DosFields.style.display = 'none';
            }
        });
    </script>

     <script>
    function toggleSqlInjection() {
    const protocolSelect5 = document.getElementById('protocol');
    const SqlInjectionContainer = document.getElementById('sql_injection_container');




    if (protocolSelect5.value === 'http') {

        SqlInjectionContainer.style.display = 'block';

        }

        else {
        SqlInjectionContainer.style.display = 'none';
        }

}

document.getElementById('protocol').addEventListener('change', toggleSqlInjection);
</script>



 <script>
    function Webshells() {
    const protocolSelect8 = document.getElementById('protocol');
    const WebshellsContainer = document.getElementById('webshells_container');




    if (protocolSelect8.value === 'http') {

        WebshellsContainer.style.display = 'block';

        }

        else {
        WebshellsContainer.style.display = 'none';
        }

}

document.getElementById('protocol').addEventListener('change', Webshells);
</script>

 <script>
    function RemoteUploads() {
    const protocolSelect7 = document.getElementById('protocol');
    const RemoteUploadsContainer = document.getElementById('remote_uploads_container');




    if (protocolSelect7.value === 'http') {

        RemoteUploadsContainer.style.display = 'block';

        }

        else {
        RemoteUploadsContainer.style.display = 'none';
        }

}

document.getElementById('protocol').addEventListener('change', RemoteUploads);
</script>


 <script>
    function toggleXSS() {
    const protocolSelect6 = document.getElementById('protocol');
    const XSSContainer = document.getElementById('XSS_container');




    if (protocolSelect6.value === 'http') {

        XSSContainer.style.display = 'block';

        }

        else {
        XSSContainer.style.display = 'none';
        }

}

document.getElementById('protocol').addEventListener('change', toggleXSS);
</script>



        <script>
    function toggleForwardFor() {
    const protocolSelect4 = document.getElementById('protocol');
    const ForwardForContainer = document.getElementById('forward_for_container');




    if (protocolSelect4.value === 'http') {

        ForwardForContainer.style.display = 'block';

        }

        else {
        ForwardForContainer.style.display = 'none';
        }

}

document.getElementById('protocol').addEventListener('change', toggleForwardFor);
</script>

    <script>
        const sslCheckbox = document.getElementById('ssl_checkbox');
        const sslFields = document.getElementById('ssl_fields');
        const sslModeSelect = document.getElementById('ssl_mode');
        const acmeFields = document.getElementById('acme_fields');
        const existingFields = document.getElementById('existing_cert_fields');
        const manualCertFields = document.getElementById('manual_cert_fields');
        const certSelect = document.getElementById('ssl_cert_path_select');
        const domainFields = document.getElementById('domain_fields');
        const domainInput = document.getElementById('domain_name');

        function toggleManualCert() {
            if (!manualCertFields || !certSelect) {
                return;
            }
            manualCertFields.style.display = certSelect.value === '__custom__' ? 'block' : 'none';
        }

        function toggleSslMode() {
            if (!sslModeSelect) {
                return;
            }
            const mode = sslModeSelect.value;
            if (acmeFields) {
                acmeFields.style.display = mode === 'acme' ? 'block' : 'none';
            }
            if (existingFields) {
                existingFields.style.display = mode === 'existing' ? 'block' : 'none';
            }
            toggleManualCert();
        }

        function toggleSslFields() {
            sslFields.style.display = sslCheckbox.checked ? 'block' : 'none';
            if (!sslCheckbox.checked) {
                return;
            }
            toggleSslMode();
        }

        function toggleDomainFields() {
            if (!domainFields || !domainInput) {
                return;
            }
            const hasValue = domainInput.value.trim().length > 0;
            domainFields.style.display = sslCheckbox.checked || hasValue ? 'block' : 'none';
            domainInput.required = sslCheckbox.checked;
        }

        sslCheckbox.addEventListener('change', toggleSslFields);
        sslCheckbox.addEventListener('change', toggleDomainFields);
        if (sslModeSelect) {
            sslModeSelect.addEventListener('change', toggleSslMode);
        }
        if (certSelect) {
            certSelect.addEventListener('change', toggleManualCert);
        }
        if (domainInput) {
            domainInput.addEventListener('input', toggleDomainFields);
        }
        toggleSslFields();
        toggleDomainFields();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof toggleSqlInjection === 'function') {
                toggleSqlInjection();
            }
            if (typeof toggleXSS === 'function') {
                toggleXSS();
            }
            if (typeof toggleForwardFor === 'function') {
                toggleForwardFor();
            }
            if (typeof Webshells === 'function') {
                Webshells();
            }
            if (typeof RemoteUploads === 'function') {
                RemoteUploads();
            }
        });
    </script>
            </main>
        </div>
    </div>
    <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
